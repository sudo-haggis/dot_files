services:
  latepoint_composer:
    container_name: 'latepoint_composer'
    image: composer:latest
    volumes:
      - .:/var/www/html
      - latepoint_vendor:/var/www/html/vendor
    working_dir: /var/www/html
    restart: "no"
    networks:
      - latepoint_network

  latepoint_wordpress_lp4:
    env_file: .env
      #user: "www-data"
    container_name: 'latepoint_wordpress_lp4'
    profiles: ["lp4"] #line added to disable lp4 unless called upon.
    depends_on:
      latepoint_db:
        condition: service_healthy
      latepoint_composer:
        condition: service_completed_successfully
    image: wpdiaries/wordpress-xdebug:6.6.0-php8.3-apache
    working_dir: /var/www/html
    environment:
      WORDPRESS_DB_NAME: '${MYSQL_DATABASE_LP4}'
      WORDPRESS_DB_USER: '${MYSQL_USER}'
      WORDPRESS_DB_PASSWORD: '${MYSQL_PASSWORD}'
      WORDPRESS_DB_HOST: '${WORDPRESS_DB_HOST}'
      WORDPRESS_TABLE_PREFIX: '${PREFIX_LP4}'
      WORDPRESS_DEBUG: '${WORDPRESS_DEBUG}'
      PHP_IDE_CONFIG: '${PHP_IDE_CONFIG}'
      XDEBUG_CONFIG: '${XDEBUG_CONFIG}'
      PATH: '$PATH:/var/www/html/vendor/bin'
      WP_ALLOW_REPAIR: true
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    volumes:
      - ./.htaccess:/var/www/html/.htaccess
      - ./docker/php/error-logging.ini:/usr/local/etc/php/conf.d/error-logging.ini
      - ./wp-config.php:/var/www/html/wp-config.php
      - latepoint_vendor:/var/www/html/vendor
      - ./rulesets:/var/www/html/rulesets
      - ./phpstan.neon:/var/www/html/phpstan.neon
      - ./tests:/var/www/html/tests
      - ./wp-content-lp4:/var/www/html/wp-content
    ports:
      - '${HTTP_PORT_LP4}'
    restart: on-failure:5
    networks:
      - latepoint_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  latepoint_wordpress_lp5:
    env_file: .env    
      #user: "www-data"
    container_name: 'latepoint_wordpress_lp5'
    depends_on:
       latepoint_db:
        condition: service_healthy
       latepoint_composer:
        condition: service_completed_successfully
    image: wpdiaries/wordpress-xdebug:6.6.0-php8.3-apache
    working_dir: /var/www/html
    environment:
      WORDPRESS_DB_NAME: '${MYSQL_DATABASE_LP5}'
      WORDPRESS_DB_USER: '${MYSQL_USER}'
      WORDPRESS_DB_PASSWORD: '${MYSQL_PASSWORD}'
      WORDPRESS_DB_HOST: '${WORDPRESS_DB_HOST}'
      WORDPRESS_TABLE_PREFIX: '${PREFIX_LP5}'
      WORDPRESS_DEBUG: '${WORDPRESS_DEBUG}'
      PHP_IDE_CONFIG: '${PHP_IDE_CONFIG}'
      XDEBUG_CONFIG: '${XDEBUG_CONFIG}'
      PATH: '$PATH:/var/www/html/vendor/bin'
      WP_ALLOW_REPAIR: true
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    volumes:
      - ./.htaccess:/var/www/html/.htaccess
      - ./docker/php/error-logging.ini:/usr/local/etc/php/conf.d/error-logging.ini
      - ./wp-config.php:/var/www/html/wp-config.php
      - latepoint_vendor:/var/www/html/vendor
      - ./rulesets:/var/www/html/rulesets
      - ./phpstan.neon:/var/www/html/phpstan.neon
      - ./tests:/var/www/html/tests
      - ./wp-content-lp5:/var/www/html/wp-content
      - ./docker/php/disable-xdebug.ini:/usr/local/etc/php/conf.d/disable-xdebug.ini
    ports:
      - '${HTTP_PORT_LP5}'
    restart: on-failure:5
    networks:
      - latepoint_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
  
  latepoint_db:
    container_name: 'latepoint_db'
    image: mariadb:lts-noble
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    ports:
      - "3306:3306"
    volumes:
      - 'latepoint_db_data:/var/lib/mysql'
      - ./docker/mysql/sql_backup.sh:/docker-entrypoint-initdb.d/sql_backup.sh
      - ./sql_dump:/sql_dump
    command: --innodb-buffer-pool-size=128M --max-connections=50
    environment:
      MYSQL_ROOT_PASSWORD: '${MYSQL_ROOT_PASSWORD}'
      MYSQL_USER: '${MYSQL_USER}'
      MYSQL_PASSWORD: '${MYSQL_PASSWORD}'
      MYSQL_DATABASE: 'latepoint_lp4'
      MYSQL_INITDB_SKIP_TZINFO: 1
    stop_signal: SIGINT
    restart: always
    networks:
      - latepoint_network
    healthcheck:
      test: ["CMD", "pidof", "mariadbd"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  
  latepoint_phpmyadmin:
    depends_on:
      latepoint_db:
        condition: service_healthy
    image: phpmyadmin/phpmyadmin:5.2.1
    container_name: 'latepoint_phpmyadmin'
    restart: on-failure:5
    ports:
      - '${PHP_MY_ADMIN_PORTS}'
    environment:
      PMA_HOST: 'latepoint_db'
      MYSQL_ROOT_PASSWORD: '${MYSQL_ROOT_PASSWORD}'
    networks:
      - latepoint_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  latepoint_vendor: {}
  latepoint_db_data:
    name: 'latepoint_db_data'

networks:
  latepoint_network:
    name: 'latepoint_network'
